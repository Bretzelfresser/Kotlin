<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    crossorigin=""></script>
	 <style> 
     	#map {height:  800px; position: abolute; top: 10; bottom: 10; left: 10; right: 10;}
     </style>
</head>                                                 
<body>
	<h1>Programmierprojekt 2021/22 Wiegel, Koppenhoefer, Wannke</h1>
	<h2>Eingebundene Karte:</h2>
	<p>Karte ueber Leaflet eingbunden:</p>

    <div id="map"></div>
    <script>
        var map = L.map('map').setView([10, 10] , 1);
        var amountMarkers = 0;
        var startMarker = null;
        var endMarker = null;
        var layerGroup = null;
        var geojsonLayer = null;
        var pathLine = null;
        var greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        L.tileLayer('https://api.maptiler.com/maps/basic/256/{z}/{x}/{y}.png?key=Q6IOPULDWc8NFSXjmQD5', {
            attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
        }).addTo(map);
        
        function onMapClick(e) {
            // Startpoint
            if (amountMarkers == 0) {
                getCoords("/getClosestNode?lat="+e.latlng.lat+"&lon="+e.latlng.lng+"&amountMarkers="+amountMarkers, startMarkerCallback);
            }
            // Endpoint
            if (amountMarkers == 1) {
                getCoords("/getClosestNode?lat="+e.latlng.lat+"&lon="+e.latlng.lng+"&amountMarkers="+amountMarkers, endMarkerCallback);
            }
            // Reset
            if (amountMarkers >= 2) {
                map.removeLayer(startMarker);
                map.removeLayer(endMarker);
                layerGroup.removeLayer(geojsonLayer);
                amountMarkers = -1;
                console.log("Removed all markers")
            }
            amountMarkers++;
        }

        getCoords = function(Url, callback)
        {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200)
                    callback(request.responseText);
            }
            request.open( "GET", Url, true );
            request.send( null );
        }

        function startMarkerCallback(data) {
            var coordsStrings = data.split(",");
            let lat = coordsStrings.shift();
            let lon = coordsStrings.shift();
            startMarker = L.marker([lat, lon]).addTo(map);
            console.log("Added blue starting marker");
        }
        
        function endMarkerCallback(data) {
            var responseStrings = data.split(",");
            var pathPositions = [];
            let lat = responseStrings[0];
            let lon = responseStrings[1];
            endMarker = L.marker([lat, lon], {icon: greenIcon}).addTo(map);
            console.log("Added green ending marker");
            
            responseStrings.pop();
            while (responseStrings.length > 0) { 
                var helperarray = [ parseFloat(responseStrings.shift()), parseFloat(responseStrings.shift()) ];
                pathPositions.push( [helperarray[1], helperarray[0]] );
            }
            //console.log(pathPositions);
            pathLine = [ { "type": "LineString", "coordinates": pathPositions }];
            geojsonLayer = L.geoJSON().addTo(map);
            geojsonLayer.addData(pathLine);
            layerGroup = new L.LayerGroup();
            layerGroup.addTo(map);
            layerGroup.addLayer(geojsonLayer);
        }

        map.on('click', onMapClick);
    </script>

</body>
</html>